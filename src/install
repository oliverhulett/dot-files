#!/bin/bash
####################################################################################################
#	Copyright (C) 2008 Oliver Slocombe Hulett <oliver.hulett@gmail.com>
#
#	This program is free software; you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation; either version 2 of the License, or
#	(at your option) any later version.
#
#	This program is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#
#	You should have received a copy of the GNU General Public License
#	along with this program; if not, write to the Free Software
#	Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
####################################################################################################

##	install
##	@author		Oliver Hulett	<oliver.hulett@gmail.com>
##	@version	0.1		2008/08/09	File created
##
##	Install a script from the current directory to /usr/local/bin and set its permissions.

KEEP_SUFFIX=false
BINDIR=/usr/local/bin
USER=`whoami`
GROUP=users
PERMS=0755

TEMP=`getopt -o 'UVhkb:u:g:p:' --long 'usage,version,help,keep-suffix,bindir:,user:,group:,perms:' -n 'install' -- "$@"`
if [ $? != 0 ]; then echo "Terminating..." >&2; exit 1; fi
eval set -- "$TEMP"

while true; do
	case "$1" in
		-b|--bindir)
			BINDIR=$2
			shift 2
			;;
		-u|--user)
			USER=$2
			shift 2
			;;
		-g|--group)
			GROUP=$2
			shift 2
			;;
		-p|--perms)
			PERMS=$2
			shift 2
			;;
		-k|--keep-suffix)
			KEEP_SUFFIX=true
			shift
			;;
		-h|--help|-U|--usage|-V|--version)
			echo "`basename $0`:  v1.1  Oliver Hulett <oliver.hulett@gmail.com>  Released under GPL"
			echo
			echo "usage:  `basename $0` -V | --version | -U | --usage | -h | -? | --help"
			echo -n "usage:  `basename $0` [-k|--keep-suffix] [-b|--bindir=path] [-u|--user=username] "
			echo "[-g|--group=group] [-p|--perms=mode] FILE..."
			cat<<EOF

	The first invocation prints this message.  All of --version, --usage and --help
	print the same thing, because I'm too lazy to write multiple informational outputs.

	The seccond invocation takes each script given on the command line, and installs it
	in bindir.  Installation involves, copying the file to the bindir, stripping the
	suffix and setting ownership and permissions.

	-k | --keep-suffix
		Keep the filename suffix.

	-b | --bindir=path
		Install to the given directory.  Default is /usr/local/bin

	-u | --user=username
		Set the executable to be owned by the given user.  Default is the
		current user as returned by \`whoami\`

	-g | --group=group
		Set the executable to be owned by the given group.  Default is users.

	-p | --perms=mode
		Set the permissions for the executable to mode.  Default is 0775.

	Arguments for long options are required for short options too.
EOF
			exit 0
			;;
		--)
			shift
			break
			;;
		*)
			echo "Argument Error!"
			exit 1
			;;
	esac
done

for script in "$@"; do
	if [ "$script" -ef "$0" ]; then
		echo "Cannot install install..."
		continue
	fi
	if [ -e "$script" ]; then
		if [ "$KEEP_SUFFIX" == "true" ]; then
			exe="$(basename $script)"
			exe="$BINDIR/$exe"
		else
			exe="$(basename $script)"
			exe="$BINDIR/${exe%.*}"
		fi
		sudo rm -f "$exe"
		sudo cp "$script" "$exe"
		sudo chmod "$PERMS" "$exe"
		sudo chown "$USER" "$exe"
		sudo chgrp "$GROUP" "$exe"
		echo "installed '$(basename $exe)' into '$BINDIR'"
	fi
done
